<!DOCTYPE html>
<html lang='ru'>
<head>
    <meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'>
<meta name='description' content='Распределённые системы имеют кучу подводных граблей. Синхронизация состояния сама по себе нетривиальная задача, которой посвящены многие работы. А уж если состояние распределено по системе…'>
<meta name='theme-color' content='#ffcd00'>

<meta property='og:title' content='Синхронизация состояния в распределённых системах • Где-то на дальнем сервере'>
<meta property='og:description' content='Распределённые системы имеют кучу подводных граблей. Синхронизация состояния сама по себе нетривиальная задача, которой посвящены многие работы. А уж если состояние распределено по системе…'>
<meta property='og:url' content='https://vporoshok.me/slides/2019/11/state-sync/'>
<meta property='og:site_name' content='Где-то на дальнем сервере'>
<meta property='og:type' content='article'><meta property='article:section' content='slides'><meta property='article:published_time' content='2019-11-16T12:24:33Z'/><meta property='article:modified_time' content='2023-11-17T17:20:06&#43;04:00'/><meta name='twitter:card' content='summary'>

<meta name="generator" content="Hugo 0.88.1" />

    <title>Синхронизация состояния в распределённых системах • Где-то на дальнем сервере</title>
    <link rel='canonical' href='https://vporoshok.me/slides/2019/11/state-sync/'>
    
    <link rel='icon' href='/favicon.ico'>
    <link rel='stylesheet' href='/assets/css/main.6a060eb7.css'><link rel='stylesheet' href='/assets/custom.css'><style>
:root{--color-accent:#ffcd00;}
</style>



    <link rel="stylesheet" href="/assets/shower/themes/material/styles/styles.css">
    <style>
        .shower {
            --slide-ratio: calc(16 / 9);
        }
        .caption a {
            display: inline-block;
            font-size: 0.8em;
            margin-left: 2em;
        }
        .mermaid {
            text-align: center;
        }
        .mermaid div {
            transform: translate(-25%, -25%);
        }
        .slide {
            background-repeat: no-repeat;
            background-size: cover;
        }
        .slide a {
            background: none;
        }
        .slide.section {
            display: flex;
            padding: 0;
            align-items: center;
            justify-content: center;
            text-shadow: white 0 0 10px;
        }
        .slide.section h2 {
            font-weight: normal;
        }
        .slide.compact pre {
            padding-top: 0;
        }
        .slide.black * {
            color: white;
            text-shadow: black 0 0 10px;
        }
        img.cover {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
    </style>
</head>
<body class="shower list entry-content">
    <header class="caption">
        <h1>Синхронизация состояния в распределённых системах</h1>
        <p>Распределённые системы имеют кучу подводных граблей. Синхронизация состояния сама по себе нетривиальная задача, которой посвящены многие работы. А уж если состояние распределено по системе…</p>
    </header>

    <!-- raw HTML omitted -->
<!-- raw HTML omitted -->
<section id="title" class="slide entry clear section black"><h2>
        Синхронизация состояния в распределённых системах
    </h2></section>

<section id="hello" class="slide entry"><h2>
        Всем привет!
    </h2><ul>
<li>Бастрыков Евгений</li>
<li>Программирую с 2013</li>
<li>Преподаю «Алгоритмы и структуры данных»</li>
<li>Разрабатываю QuickBPM</li>
</ul>
<!-- raw HTML omitted -->
</section>

<section id="toc" class="slide entry toc"><h2>
        План
    </h2><ol>
<li><a href="#redis">кеш во внешнем сервисе</a></li>
<li><a href="#local">кеш внутри сервиса</a></li>
<li><a href="#sharding">шардирование</a></li>
</ol>
</section>

<section class="slide entry"><h2 class="shout">
        Не используйте, если можете
    </h2></section>

<section id="redis" class="slide entry section"><h2>
        Кеш во внешнем сервисе
    </h2></section>

<section class="slide entry"><h2>
        Кеш во внешнем сервисе
    </h2><!-- raw HTML omitted --></section>

<section class="slide entry"><h2>
        Кеш во внешнем сервисе
    </h2><p>Идеален, если</p>
<ul>
<li>чистые данные</li>
<li>не меняются</li>
<li>подготовка занимает время/ресурсы</li>
</ul>
</section>

<section class="slide entry"><h2>
        Кеш во внешнем сервисе
    </h2>Проблемы:</p>
<!-- raw HTML omitted --></section>

<section class="slide entry"><h2>
        Кеш во внешнем сервисе
    </h2><!-- raw HTML omitted -->
<pre><code>&lt;/figcaption&gt;
</code></pre>
<!-- raw HTML omitted -->
</section>

<section class="slide entry clear section black"><h2>
        Локи
    </h2></section>

<section class="slide entry"><h2>
        Кеш во внешнем сервисе
    </h2><p>Проблемы:</p>
<ul>
<li>гонка на создании (трата ресурсов)</li>
<li>гонка на обновление (атомарное обновление: inc/dec/CAS)</li>
<li>гонка создания и обновления (блокировки)</li>
</ul>
</section>

<section class="slide entry"><div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-lua" data-lang="lua"><span style="color:#080;font-weight:bold">local</span> c <span style="color:#333">=</span> redis.call(<span style="background-color:#fff0f0">&#34;HGET&#34;</span>, KEYS[<span style="color:#00d;font-weight:bold">1</span>], ARGV[<span style="color:#00d;font-weight:bold">1</span>])
<span style="color:#080;font-weight:bold">if</span> c <span style="color:#333">==</span> <span style="color:#080;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">or</span> tonumber(c) <span style="color:#333">&lt;=</span> <span style="color:#333">-</span>tonumber(ARGV[<span style="color:#00d;font-weight:bold">2</span>]) <span style="color:#080;font-weight:bold">then</span>
    redis.call(<span style="background-color:#fff0f0">&#34;HDEL&#34;</span>, KEYS[<span style="color:#00d;font-weight:bold">1</span>], ARGV[<span style="color:#00d;font-weight:bold">1</span>])
    <span style="color:#080;font-weight:bold">return</span> <span style="color:#00d;font-weight:bold">0</span>
<span style="color:#080;font-weight:bold">end</span>
redis.call(<span style="background-color:#fff0f0">&#34;HINCRBY&#34;</span>, KEYS[<span style="color:#00d;font-weight:bold">1</span>], ARGV[<span style="color:#00d;font-weight:bold">1</span>], ARGV[<span style="color:#00d;font-weight:bold">2</span>])
<span style="color:#080;font-weight:bold">local</span> updatedCount <span style="color:#333">=</span> redis.call(<span style="background-color:#fff0f0">&#34;HGET&#34;</span>, KEYS[<span style="color:#00d;font-weight:bold">1</span>], ARGV[<span style="color:#00d;font-weight:bold">1</span>])
<span style="color:#080;font-weight:bold">return</span> tonumber(updatedCount)
</code></pre></div></section>

<section id="redis" class="slide entry section"><h2>
        Кеш внутри сервиса
    </h2></section>

<section class="slide entry"><h2>
        Кеш внутри сервиса
    </h2><p>Почему?</p>
<ul>
<li>Не просто данные</li>
<li>Нагрузка на сеть</li>
</ul>
</section>

<section class="slide entry"><h2>
        Кеш внутри сервиса
    </h2><p>Что можно делать?</p>
<ul>
<li>Создавать</li>
<li>Читать</li>
<li><del>Менять</del></li>
<li>Инвалидировать</li>
</ul>
</section>

<section class="slide entry"><h2>
        Кеш внутри сервиса
    </h2><p>Оповещение об инвалидации:</p>
<ul>
<li>gossip</li>
<li>message queue</li>
<li>key-value</li>
</ul>
</section>

<section class="slide entry"><h2>
        Кеш внутри сервиса
    </h2>Флаг</p>
<!-- raw HTML omitted -->
<!-- raw HTML omitted --></section>

<section class="slide entry"><h2 class="shout">
        Расхождение часов
    </h2></section>

<section class="slide entry"><h2>
        Расхождение часов
    </h2><div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go">ts <span style="color:#333">:=</span> time.<span style="color:#06b;font-weight:bold">Now</span>().<span style="color:#06b;font-weight:bold">UTC</span>()
claims <span style="color:#333">:=</span> <span style="color:#333">&amp;</span>jwt.StandardClaims{
    IssuedAt: ts.<span style="color:#06b;font-weight:bold">Add</span>(<span style="color:#333">-</span>deviateIssuedAt).<span style="color:#06b;font-weight:bold">Unix</span>(),
    ExpiresAt: ts.<span style="color:#06b;font-weight:bold">Add</span>(validTTL).<span style="color:#06b;font-weight:bold">Unix</span>(),
}
</code></pre></div></section>

<section class="slide entry clear"><h2>
        Расхождение часов
    </h2><!-- raw HTML omitted -->
<pre><code>&lt;/figcaption&gt;
</code></pre>
<!-- raw HTML omitted -->
</section>

<section id="sharding" class="slide entry section"><h2>
        Шардирование
    </h2></section>

<section class="slide entry"><h2>
        Шардирование
    </h2><p>За определённое состояние должен отвечать только один сервис</p>
<ul>
<li>таймеры</li>
<li>изменения в бд</li>
<li>акторы</li>
</ul>
</section>



    <footer class="badge">
        <a href="/">На главную</a>
    </footer>

    <div class="progress"></div>

    <script src="/assets/shower/shower.min.js"></script><script>window.__assets_js_src="/assets/js/"</script>

<script src='/assets/js/main.67d669ac.js'></script><script src='/assets/mermaid.min.js' />

<script type='text/javascript'>
  mermaid.initialize({});
</script>

</body>
</html>
