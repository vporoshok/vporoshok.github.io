<!DOCTYPE html>
<html lang='ru'><head>
  <meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'>
<meta name='description' content='Лишь чёрный ворон надо мной бредит'>
<meta name='theme-color' content='#ffcd00'>

<meta property='og:title' content='Залогируй это • Где-то на дальнем сервере'>
<meta property='og:description' content='Лишь чёрный ворон надо мной бредит'>
<meta property='og:url' content='https://vporoshok.me/post/2020/07/logs/'>
<meta property='og:site_name' content='Где-то на дальнем сервере'>
<meta property='og:type' content='article'><meta property='article:section' content='post'><meta property='article:tag' content='logging'><meta property='article:tag' content='go'><meta property='article:published_time' content='2020-07-15T19:25:46Z'/><meta property='article:modified_time' content='2020-07-15T23:27:21&#43;04:00'/><meta name='twitter:card' content='summary'>

<meta name="generator" content="Hugo 0.57.2" />

  <title>Залогируй это • Где-то на дальнем сервере</title>
  <link rel='canonical' href='https://vporoshok.me/post/2020/07/logs/'>
  
  
  <link rel='icon' href='/favicon.ico'>
<link rel='stylesheet' href='/assets/css/main.6a060eb7.css'><link rel='stylesheet' href='/assets/custom.css'><style>
:root{--color-accent:#ffcd00;}
</style>

<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-41042060-2', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

  

</head>
<body class='page type-post has-sidebar'>

  <div class='site'><div id='sidebar' class='sidebar'>
  <a class='screen-reader-text' href='#main-menu'>Перейти к основному меню</a>

  <div class='container'><section class='widget widget-about sep-after'>
  <header>
    
    <div class='logo'>
      <a href='/'>
        <img src='/images/logo.jpg' alt="Вернуться на главную">
      </a>
    </div>
    
    <h2 class='title site-title '>
    vporoshok.me
    </h2>
    <div class='desc'>
    Где-то на дальнем сервере
    </div>
  </header>

</section>
<section class='widget widget-social_menu sep-after'><nav aria-label='Соцсети'>
    <ul><li>
        <a href='https://twitter.com/vporoshok' target='_blank' rel='noopener'>
          <span class='screen-reader-text'>Открыть Twitter-акаунт в новой вкладке</span><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z"/>
  
</svg>
</a>
      </li><li>
        <a href='https://github.com/vporoshok' target='_blank' rel='noopener'>
          <span class='screen-reader-text'>Открыть Github-акаунт в новой вкладке</span><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"/>
  
</svg>
</a>
      </li><li>
        <a href='mailto:vporoshok@gmail.com' target='_blank' rel='noopener'>
          <span class='screen-reader-text'>Связаться через Email</span><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
  <polyline points="22,6 12,13 2,6"/>
  
</svg>
</a>
      </li><li>
        <a href='https://t.me/vporoshok' target='_blank' rel='noopener'>
          <span class='screen-reader-text'>Открыть Telegram-акаунт в новой вкладке</span><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <path d="m 22.05,1.577 c -0.393,-0.016 -0.784,0.08 -1.117,0.235 -0.484,0.186 -4.92,1.902 -9.41,3.64 C 9.263,6.325 7.005,7.198 5.267,7.867 3.53,8.537 2.222,9.035 2.153,9.059 c -0.46,0.16 -1.082,0.362 -1.61,0.984 -0.79581202,1.058365 0.21077405,1.964825 1.004,2.499 1.76,0.564 3.58,1.102 5.087,1.608 0.556,1.96 1.09,3.927 1.618,5.89 0.174,0.394 0.553,0.54 0.944,0.544 l -0.002,0.02 c 0,0 0.307,0.03 0.606,-0.042 0.3,-0.07 0.677,-0.244 1.02,-0.565 0.377,-0.354 1.4,-1.36 1.98,-1.928 l 4.37,3.226 0.035,0.02 c 0,0 0.484,0.34 1.192,0.388 0.354,0.024 0.82,-0.044 1.22,-0.337 0.403,-0.294 0.67,-0.767 0.795,-1.307 0.374,-1.63 2.853,-13.427 3.276,-15.38 L 23.676,4.725 C 23.972,3.625 23.863,2.617 23.18,2.02 22.838,1.723 22.444,1.593 22.05,1.576 Z"/>
  
</svg>
</a>
      </li></ul>
  </nav>
</section><section class='widget widget-sidebar_menu sep-after'><nav id='sidebar-menu' class='menu sidebar-menu' aria-label='Боковое меню'>
    <div class='container'>
      <ul><li class='item'>
  <a href='/categories/algorithm/'>Алгоритмы</a></li><li class='item'>
  <a href='/categories/develop/'>Разработка</a></li><li class='item'>
  <a href='/categories/life-style/'>Образ жизни</a></li><li class='item'>
  <a href='/categories/book/'>Книги</a></li><li class='item'>
  <a href='/slides/'>Презентации</a></li><li class='item'>
  <a href='/categories/project/'>Проекты</a></li></ul>
    </div>
  </nav>

</section><section class='widget widget-taxonomy_cloud sep-after'>
  <header>
    <h4 class='title widget-title'>Тэги</h4>
  </header>

  <div class='container list-container'>
  <ul class='list taxonomy-cloud no-shuffle'><li>
        <a href='/tags/algorithm/' style='font-size:1em'>algorithm</a>
      </li><li>
        <a href='/tags/angular/' style='font-size:1em'>angular</a>
      </li><li>
        <a href='/tags/architect/' style='font-size:1.625em'>architect</a>
      </li><li>
        <a href='/tags/blog/' style='font-size:1em'>blog</a>
      </li><li>
        <a href='/tags/checklist/' style='font-size:1.375em'>checklist</a>
      </li><li>
        <a href='/tags/complexity/' style='font-size:1.5em'>complexity</a>
      </li><li>
        <a href='/tags/csrf/' style='font-size:1em'>CSRF</a>
      </li><li>
        <a href='/tags/data-structure/' style='font-size:1.375em'>data-structure</a>
      </li><li>
        <a href='/tags/distributed-system/' style='font-size:1em'>distributed system</a>
      </li><li>
        <a href='/tags/event/' style='font-size:1em'>event</a>
      </li><li>
        <a href='/tags/git/' style='font-size:1em'>git</a>
      </li><li>
        <a href='/tags/go/' style='font-size:2em'>go</a>
      </li><li>
        <a href='/tags/graph/' style='font-size:1.125em'>graph</a>
      </li><li>
        <a href='/tags/hackathon/' style='font-size:1em'>hackathon</a>
      </li><li>
        <a href='/tags/keynote/' style='font-size:1em'>keynote</a>
      </li><li>
        <a href='/tags/logging/' style='font-size:1em'>logging</a>
      </li><li>
        <a href='/tags/management/' style='font-size:1.125em'>management</a>
      </li><li>
        <a href='/tags/memory/' style='font-size:1.25em'>memory</a>
      </li><li>
        <a href='/tags/microservices/' style='font-size:1.125em'>microservices</a>
      </li><li>
        <a href='/tags/orgmode/' style='font-size:1em'>orgmode</a>
      </li><li>
        <a href='/tags/php/' style='font-size:1em'>PHP</a>
      </li><li>
        <a href='/tags/python/' style='font-size:1.125em'>python</a>
      </li><li>
        <a href='/tags/rules/' style='font-size:1.125em'>rules</a>
      </li><li>
        <a href='/tags/rxjs/' style='font-size:1em'>rxjs</a>
      </li><li>
        <a href='/tags/scheme/' style='font-size:1.125em'>scheme</a>
      </li><li>
        <a href='/tags/scrum/' style='font-size:1.125em'>scrum</a>
      </li><li>
        <a href='/tags/security/' style='font-size:1em'>security</a>
      </li><li>
        <a href='/tags/sicp/' style='font-size:1.125em'>sicp</a>
      </li><li>
        <a href='/tags/sorting/' style='font-size:1em'>sorting</a>
      </li><li>
        <a href='/tags/state-machine/' style='font-size:1em'>state-machine</a>
      </li><li>
        <a href='/tags/team-lead/' style='font-size:1em'>team-lead</a>
      </li><li>
        <a href='/tags/testing/' style='font-size:1.125em'>testing</a>
      </li><li>
        <a href='/tags/tips-and-tricks/' style='font-size:1.25em'>tips and tricks</a>
      </li><li>
        <a href='/tags/toc/' style='font-size:1em'>toc</a>
      </li><li>
        <a href='/tags/tutorial/' style='font-size:1.125em'>tutorial</a>
      </li><li>
        <a href='/tags/typescript/' style='font-size:1em'>typescript</a>
      </li><li>
        <a href='/tags/web/' style='font-size:1em'>web</a>
      </li><li>
        <a href='/tags/work/' style='font-size:1em'>work</a>
      </li></ul>
</div>


</section>
</div>

  <div class='sidebar-overlay'></div>
</div><div class='main'><nav id='main-menu' class='menu main-menu' aria-label='Основное меню'>
  <div class='container'>
    <a class='screen-reader-text' href='#content'>Перейти к содержимому</a>

<button id='sidebar-toggler' class='sidebar-toggler' aria-controls='sidebar'>
  <span class='screen-reader-text'>Скрыть / показать боковую панель</span>
  <span class='open'><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <line x1="3" y1="12" x2="21" y2="12" />
  <line x1="3" y1="6" x2="21" y2="6" />
  <line x1="3" y1="18" x2="21" y2="18" />
  
</svg>
</span>
  <span class='close'><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <line x1="18" y1="6" x2="6" y2="18" />
  <line x1="6" y1="6" x2="18" y2="18" />
  
</svg>
</span>
</button>
    <ul><li class='item'>
        <a href='/post/'>Блог</a>
      </li><li class='item'>
        <a href='/page/about/'>Обо мне</a>
      </li></ul>
  </div>
</nav><div class='header-widgets'>
        <div class='container'></div>
      </div>

      <header id='header' class='header site-header'>
        <div class='container sep-after'>
          <div class='header-info'><p class='site-title title'>Где-то на дальнем сервере</p><p class='desc site-desc'>Заметки о программировании и не только</p>
          </div>
        </div>
      </header>

      <main id='content'>


<article lang='ru' class='entry'>
  <header class='header entry-header'>
  <div class='container sep-after'>
    <div class='header-info'>
      <h1 class='title'>Залогируй это</h1>
      
<p class='desc'>Лишь чёрный ворон надо мной бредит</p>


    </div>
    
<div class='entry-meta'>
  <span class='posted-on'><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
  <line x1="16" y1="2" x2="16" y2="6"/>
  <line x1="8" y1="2" x2="8" y2="6"/>
  <line x1="3" y1="10" x2="21" y2="10"/>
  
</svg>
<span class='screen-reader-text'>Опубликовано </span>
  <time class='entry-date' datetime='2020-07-15T19:25:46Z'>2020-07-15</time>
</span>

  
  
<span class='reading-time'><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <circle cx="12" cy="12" r="10"/>
  <polyline points="12 6 12 12 15 15"/>
  
</svg>
13 минут на чтение
</span>


  
</div>


  </div>
</header>

  
  
<details class='container entry-toc'>
  <summary class='title'>
    <span>Оглавление</span>
  </summary>
  <nav id="TableOfContents">
<ul>
<li>
<ul>
<li><a href="#роли-и-задачи">Роли и задачи</a>
<ul>
<li><a href="#разработчик">Разработчик</a></li>
<li><a href="#эксплуатация">Эксплуатация</a></li>
<li><a href="#служба-технической-поддержки">Служба технической поддержки</a></li>
<li><a href="#архитектор">Архитектор</a></li>
<li><a href="#автоматические-системы">Автоматические системы</a></li>
</ul></li>
<li><a href="#способы-работы-с-логами">Способы работы с логами</a>
<ul>
<li><a href="#активное-пассивное">Активное / пассивное</a></li>
<li><a href="#исторические-данные-воспроизведение-инцидента">Исторические данные / воспроизведение инцидента</a></li>
<li><a href="#статистика-конкретный-запрос">Статистика / конкретный запрос</a></li>
<li><a href="#поиск-аномалий-проверка-гипотез">Поиск аномалий / проверка гипотез</a></li>
</ul></li>
<li><a href="#инструменты-работы-с-логами">Инструменты работы с логами</a>
<ul>
<li><a href="#текстовые-процессоры">Текстовые процессоры</a></li>
<li><a href="#graylog">Graylog</a></li>
<li><a href="#kibana">Kibana</a></li>
<li><a href="#loki">Loki</a></li>
<li><a href="#другое">Другое</a></li>
</ul></li>
<li><a href="#форматы">Форматы</a></li>
<li><a href="#структура-записи">Структура записи</a>
<ul>
<li><a href="#временная-метка">Временная метка</a></li>
<li><a href="#система-подсистема-имя-логера">Система / подсистема / имя логера</a></li>
<li><a href="#уровень">Уровень</a>
<ul>
<li><a href="#error">ERROR</a></li>
<li><a href="#warning">WARNING</a></li>
<li><a href="#info">INFO</a></li>
<li><a href="#debug">DEBUG</a>
<ul>
<li><a href="#включение-debug-для-подсистемы">Включение DEBUG для подсистемы</a></li>
<li><a href="#временное-включение-debug">Временное включение DEBUG</a></li>
<li><a href="#включение-debug-для-конкретного-запроса">Включение DEBUG для конкретного запроса</a></li>
</ul></li>
</ul></li>
<li><a href="#запрос">Запрос</a></li>
<li><a href="#сообщение">Сообщение</a></li>
<li><a href="#другое-1">Другое</a></li>
</ul></li>
<li><a href="#итого">Итого</a></li>
</ul></li>
</ul>
</nav>
</details>


  <div class='container entry-content'>
  

<p>С самого начала моей карьеры программиста я на каждом углу встречал напутствия в стиле: «Пишите как можно больше логов, логируйте всё». Но все попытки логировать всё подряд приводили лишь к огромным файлам, в которых ничего не понять. И нигде мне не встречалось вразумительного руководства что и как надо логировать. Что ж, накопив немного опыта, давайте попробуем разобраться в этом вопросе.</p>

<h2 id="роли-и-задачи">Роли и задачи</h2>

<p>Прежде чем определять <strong>что</strong> писать в логи, необходимо разобраться кто и с какой целью их будет читать, ведь от модели использования будет зависеть ожидаемое содержимое.</p>

<h3 id="разработчик">Разработчик</h3>

<p>Конечно, первый, кто приходит в голову, это разработчик. Но с какой целью разработчик будет читать логи и в какой момент? Во первых во время разработки логи являются одним из средств отладки разрабатываемого функционала. Во вторых, логи зачастую являются единственным источником знаний при разборе некорректного поведения системы. Ещё одной ситуацией, в которой мне часто приходится заглядывать в логи как разработчику, это определение проблем с внешними системами. Например, если у внешней системы просрочен сертификат или система перегружена, зачастую логи одного сервиса позволяют отладить поведение другого. Кроме того, бывают ошибки системы, которые легко воспроизвести в боевом окружении, но непонятно в чём проблема. Тогда можно, например, переключить уровень логирования и повторить ошибку, чтобы понять где что-то пошло не так. Итого:</p>

<ul>
<li>отладка разрабатываемого функционала;</li>
<li>разбор некорректного поведения системы в прошлом;</li>
<li>разбор некорректного поведения системы в настоящем;</li>
<li>определение внешних проблем;</li>
</ul>

<h3 id="эксплуатация">Эксплуатация</h3>

<p>Лишь в последнем проекте я столкнулся с ситуацией, когда у разработчиков нет прямого доступа к системе в бою. Есть специальный отдел службы эксплуатации. На всех прошлых проектах разработчики или по крайней мере часть из них сопровождали проект и имели полный доступ к боевому окружению. Специалисты службы эксплуатации поддерживает не один проект и имеют наработанный стэк инструментов. В целом, думаю, что для больших систем и больших команд это вполне распространённая ситуация. При этом задачи у службы эксплуатации, которые решаются в том числе с помощью логов, следующие:</p>

<ul>
<li>мониторинг здоровья сервиса;</li>
<li>мониторинг связанности среды;</li>
<li>разбор ошибок при падении или отказе стартовать сервиса;</li>
</ul>

<h3 id="служба-технической-поддержки">Служба технической поддержки</h3>

<p>Служба технической поддержки разбирает проблемы, возникающие у пользователя. Это могут быть как исторические проблемы, так и воспроизводимые в моменте задачи. Часто специалисты СТП имеют доступ до таких ресурсов, как БД, дашборды метрик, а также логи. Задачи СТП при работе с логами следующие:</p>

<ul>
<li>нахождение запроса в прошлом (ориентируясь на время, пользователя или другие ограничения);</li>
<li>восстановление контекста конкретного запроса;</li>
<li>нахождение сервиса источника ошибки;</li>
<li>возможность повторить запрос;</li>
</ul>

<h3 id="архитектор">Архитектор</h3>

<p>Если честно, не знаю какой отдел должен заниматься вопросами оптимизации, чаще всего это сваливается либо на архитектора системы, либо на конечного разработчика. Высокоуровневый обзор текущего перфоманса системы нужно получать с использованием метрик, но часто возникает необходимость составить карту конкретного запроса: какие операции выполнялись в каком порядке и сколько времени они заняли:</p>

<ul>
<li>мониторинг различных участков кода на частоту и время обращения;</li>
<li>разбор отдельных запросов с построением карты взаимодействий;</li>
</ul>

<h3 id="автоматические-системы">Автоматические системы</h3>

<p>Помимо специалистов различных служб и отделов к логам также часто подключаются автоматические системы, такие как системы оповещения или формирования метрик. Конечно для каждой задачи лучше использовать подходящий инструмент, но в целом логи могут решить и эти задачи, а бывают ситуации, когда к другой информации просто нет доступа.</p>

<ul>
<li>формирование метрик;</li>
<li>события для сервисов оповещения;</li>
</ul>

<h2 id="способы-работы-с-логами">Способы работы с логами</h2>

<p>Итак, с помощью логов хочется решить широкий круг задач. При этом для решения разных задач взаимодействие с потоком логов тоже различное.</p>

<h3 id="активное-пассивное">Активное / пассивное</h3>

<p>Первое разделение по работе с логами можно провести по способу чтения логов. Для многих задач требуется поиск и сбор информации по логам, фильтрация и поиск. Это активное взаимодействие с логами как с набором данных. Некоторая же часть задач решается пассивным наблюдением за потоком логов, например, мониторинг здоровья сервиса или формирование метрик. В данном случае исторические данные не важны, важны лишь вновь поступающие записи, которые пассивно просматриваются.</p>

<h3 id="исторические-данные-воспроизведение-инцидента">Исторические данные / воспроизведение инцидента</h3>

<p>Активное взаимодействие с логами можно поделить также на археологические раскопки в логах прошлого, либо попытках узнать правду при моделировании и воспроизведении инцидента. При этом в настоящем времени мы можем изменить конфигурацию сервиса, в историческом анализе мы не можем получить какой-либо другой информации.</p>

<h3 id="статистика-конкретный-запрос">Статистика / конкретный запрос</h3>

<p>С другой стороны способ просмотра логов можно разделить по тому, ищем ли мы одинаковые записи логов для формирования статистики работы определённого участка кода, либо рассматриваем отдельно взятый запрос от и до, восстанавливая его контекст и события, которые произошли по мере его выполнения. Иногда требуется смешать эти подходы, особенно при отладке, когда хочется узнать детали выполнения конкретного запроса, но в разрезе ограниченного участка системы.</p>

<h3 id="поиск-аномалий-проверка-гипотез">Поиск аномалий / проверка гипотез</h3>

<p>Также при возникновении некорректного поведения системы логи читаются в двух состояниях: в голове есть гипотеза о том, что могло пойти не так и необходимо эту гипотезу подтвердить или опровергнуть, либо нет ни малейшего представления об источнике проблем, есть лишь надежда увидеть аномалию в логах, которая подскажет на каком этапе возникла ошибка.</p>

<h2 id="инструменты-работы-с-логами">Инструменты работы с логами</h2>

<h3 id="текстовые-процессоры">Текстовые процессоры</h3>

<p>Первое, что мне приходит на ум в разговоре о логах, это джентльменский набор <code>grep</code>, <code>cut</code>, <code>head</code>, <code>tail</code>, <code>wc</code> и в особо тяжёлых случаях <code>sed</code> и <code>awk</code>. Хотя в последнее время многие системы используют для логов JSON, а это означает, что в инструментарий обязательно надо добавить <code>jq</code>. Эти инструменты отлично подходят не только при работе с логами в файлах, но и в случае использования стека Docker/k8s.</p>

<h3 id="graylog">Graylog</h3>

<p>Недавно столкнулся с этим инструментом и пока у меня совершенно негативные впечатления, впрочем возможно это связано с рецептом его приготовления. В данном случае готовим его не мы, нам лишь ставят в укор, что логи у нас не того формата, что graylog плохо работает с JSON и лучше использовать формат syslog.</p>

<h3 id="kibana">Kibana</h3>

<p>Стандарт де-факто в области работы с логами. Идеально работает с JSON, но надо использовать фиксированный набор полей во всех записях, либо сваливать неструктурированный объект в отдельное поле, а дальше использовать полнотекстовый поиск.</p>

<h3 id="loki">Loki</h3>

<p>Молодой продукт от команды Grafana. Легко интегрируется в k8s, можно делать частичную индексацию записей (по общим полям), а также использовать достаточно шустрый полнотекст. В целом ощущения самые позитивные.</p>

<h3 id="другое">Другое</h3>

<p>У меня практически нет опыта со стеком на основе ClickHouse, так что ничего не могу про него сказать. Также, конечно, я не упоминаю здесь такие промежуточные инструменты как Logstash и Fluentd. Настройкой каждого из них можно посвятить по отдельной статье и даже не одной, но принципиальной разницы для вопроса «что и как писать в логи?» они не несут.</p>

<h2 id="форматы">Форматы</h2>

<p>Исходя из инструментов наиболее востребованными форматами для логов являются:</p>

<ul>
<li><strong>человекочитаемый</strong> Многие системы логов предоставляют из коробки удобный для чтения в консоли формат с подсветкой разных уровней логов цветами, а сообщений жирным текстом, сокращение метки времени (ведь во время отладки мы редко уходим за пределы одного дня).</li>
<li><strong>syslog</strong> Несмотря на свою неказистость этот формат используется многими системами и возможность вывода логов в этом формате может сильно облегчить жизнь в плохо контролируемой среде эксплуатации.</li>
<li><strong>JSON</strong> Набирающий обороты формат для всего, что плохо лежит. Избыточность данных в каждой записи и вольность интерпретации. Используя этот формат надо помнить про то, что многие системы всё же рассчитывают на фиксированный набор полей, по крайней мере для индексации.</li>
</ul>

<h2 id="структура-записи">Структура записи</h2>

<p>Исходя из задач и форматов можно определить набор полей записи лога.</p>

<h3 id="временная-метка">Временная метка</h3>

<p>Когда-то я очень рассчитывал на милли- и микро- секунды в этом поле, считая это заменой метрикам выполнения, но тут надо помнить про пару нюансов: многие системы хранения логов, тот же ELK стек работают только с миллисекундами, к тому же некоторые инструменты норовят использовать собственную временную метку. Так что сильно полагаться на это поле не стоит, а точные замеры времени выполнения интересующих участков кода лучше писать отдельной записью в логи как уже высчитанное значение, ну и использовать механизм метрик, если такая возможность есть.</p>

<h3 id="система-подсистема-имя-логера">Система / подсистема / имя логера</h3>

<p>В разных библиотеках эта сущность называется по разному, однако, так или иначе присутствует. Даже в аскетичном стандартном логере Go есть понятие префикса, которое можно использовать для этих целей. Для многих задач, решаемых с помощью логов необходимо сузить набор записей выборки, например, посмотреть логи подсистемы работы с БД или HTTP-интерфейса. Это поле также хорошо работает в связке с <a href="#debug">уровнем DEBUG</a>.</p>

<h3 id="уровень">Уровень</h3>

<p>Камень преткновения во всех системах логов. Некоторые, например, создатели Go, <a href="https://dave.cheney.net/2015/11/05/lets-talk-about-logging">считают, что уровень логов излишняя сущность</a>. Но многие системы предлагают набор уровней, так почему бы этим не пользоваться. Давайте же разберёмся какой уровень для чего лучше использовать. Разберём самые распространённые уровни, не затрагивая такие крайности как TRACE, FATAL и CRITICAL.</p>

<h4 id="error">ERROR</h4>

<p>Самый высокий уровень логирования из рассматриваемых. Этот уровень должен срабатывать редко, только в тех случаях, когда сервис или окружение работает некорректно и возникающая ошибка не обработана логикой сервиса. Например, если сервис обращается к внешнему АПИ, которое работает нестабильно постоянно, то сыпать сообщениями уровня ERROR в данном случае мало эффективно. Лучше реализовать систему повторных обращений, буфера отправки или предохранителя, таким образом частые проблемы будут обработаны, а у службы эксплуатации не будет болеть голова от ошибок в неконтролируемой среде. С другой стороны, разрыв соединения с БД или другая непредвиденная ситуация в окружении сервиса хороший повод для логирования ошибки. Таким образом сообщения этого уровня отлично подходят для решения задач</p>

<ul>
<li>определение внешних проблем;</li>
<li>мониторинг здоровья сервиса;</li>
<li>мониторинг связанности среды;</li>
<li>разбор ошибок при падении или отказе стартовать сервиса;</li>
<li>события для сервисов оповещения;</li>
</ul>

<p>Этот уровень наиболее подходит для пассивного мониторинга логов. При этом сообщения этого уровня будут рассматриваться изолированно от контекста, поэтому необходимо делать их максимально самодостаточными, они должны нести как можно больше контекста, например:</p>

<ul>
<li>в рамках какого запроса произошла ошибка (url и метод для HTTP);</li>
<li>кто выполнял запрос (идентификатор пользователя и другие параметры авторизации либо user agent для автоматических систем);</li>
<li>параметры запроса, если это возможно (довольно деликатный момент из-за персональных данных и других секретов, но если в сообщении об ошибке будет полное описание того как воспроизвести запрос, это бесспорно лучший контекст);</li>
<li>версия сервиса (часто ошибки возникают во время обновления системы и по времени трудно определить какая версия записала ошибку);</li>
<li>состояние модели в методе которой возникла ошибка и аргументы вызова этого метода;</li>
<li>стек вызовов, приведший к ошибке;</li>
</ul>

<p>Конечно, записать в одно сообщение всё состояние системы не получится, так что для восстановления полного контекста скорее всего придётся отдельно искать логи по идентификатору запроса или в определённом временном интервале, но чем более полный контекст будет сформирован вокруг ошибки, тем более точная первоначальная гипотеза будет сформулирована.</p>

<h4 id="warning">WARNING</h4>

<p>Промежуточный уровень между ошибками и информационными сообщениями можно использовать для выявления аномалий в работе системы. Обрабатываемые или некритичные ошибки могут в исторической перспективе объяснить непредвиденные инциденты. Так как аномалии часто рассматриваются как история, то хорошо также насыщать контекст записи частью информации:</p>

<ul>
<li>в рамках какого запроса произошла ошибка (url и метод для HTTP);</li>
<li>кто выполнял запрос (идентификатор пользователя и другие параметры авторизации либо user agent для автоматических систем);</li>
</ul>

<p>При этом подробная информация о стеке вызовов или аргументов вызова в данном случае будет излишней, так как ошибка обработана, и тот же стек должен быть гарантирован уникальным текстом сообщения.</p>

<p>Кроме того, так как этот уровень предусматривает более или менее фиксированный набор сообщений можно также использовать его для сообщений с метриками. При этом важна строгость в тексте сообщений, переменные части записи лучше вынести в дополнительную информацию, используя текст сообщения как фиксированную строку для поиска. Лучше обложить такими метриками все вызовы к внешним системам: БД, другие сервисы, стороннее АПИ.</p>

<h4 id="info">INFO</h4>

<p>Этот уровень логов не обрабатывается автоматическими системами в пассивном режиме, поэтому строгих правил оформления сообщений на этом уровне нет, но надо придерживаться правил необходимости и достаточности, а именно</p>

<p><strong>Необходимо</strong> чтобы имея только записи этого уровня найти запрос по абстрактному описанию: примерное время, пользователь или идентификатор внешней системы, команда. Какие сущности затрагивались в рамках этого запроса и с каким результатом он завершился. Действительно, использовать более высокие уровни логирования для ошибок авторизации или ошибки в данных запроса может быть излишне (хотя это может оказаться признаком неисправности во внешнем сервисе), но пользователь может заинтересоваться что именно пошло не так, почему его запрос, который он посылал в обед понедельника на прошлой неделе не был выполнен. В данном случае по запросу может не быть записей с уровнем ERROR или WARNING, но необходимо иметь возможность составить контекст и результат запроса.</p>

<p><strong>Достаточно</strong> ровно то, что необходимо. Излишние логи или дополнительные данные в них не принесут пользы, но добавят нагрузку на систему хранения и затруднят чтение.</p>

<h4 id="debug">DEBUG</h4>

<p>Это самый детальный уровень логирования. Исходя из названия он применим для отладки поведения системы. Часто этот уровень отключают в боевом окружении. Что писать в этом уровне самая большая неопределённость из-за свободы. В целом, сообщения на этом уровне остаются на усмотрение разработчика, но такие логи лучше делать через логеры со специальными именами. Чаще всего в боевом окружении логи этого уровня не пишутся, однако, необходимо иметь механизмы их включения, желательно частичного. Для этого удобно использовать следующие механизмы</p>

<h5 id="включение-debug-для-подсистемы">Включение DEBUG для подсистемы</h5>

<p>На уровне конфигурации сервиса хорошо иметь параметр DEBUG, через который можно указать логи уровня DEBUG каких подсистем надо выводить в stderr. Например с использованием регулярных выражений или <a href="https://www.rabbitmq.com/tutorials/tutorial-five-python.html">масок биндинга RabbitMQ</a>.</p>

<h5 id="временное-включение-debug">Временное включение DEBUG</h5>

<p>Для перечитывания конфигурации обычно необходим перезапуск сервиса, что не всегда удобно в боевом окружении. Куда удобнее иметь возможность включить логи уровня DEBUG на лету. Это можно сделать несколькими способами:</p>

<ul>
<li>внутренний HTTP-метод. Удобный с точки зрения реализации, потому как не требует больших доработок, сервисы чаще всего уже имеют http-интерфейс;</li>
<li>внешнее хранилище конфигурации. База данных или key-value хранилище, которое сервис будет с определённой периодичностью опрашивать, удобно при наличии нескольких экземпляров сервиса, как единое место конфигурации;</li>
</ul>

<h5 id="включение-debug-для-конкретного-запроса">Включение DEBUG для конкретного запроса</h5>

<p>Наличие в Go такого механизма как контекст запроса позволяет вводить специфику обработки отдельного запроса. Для этого достаточно передать в заголовках некоторый признак, по которому все или некоторые записи в лог в рамках этого запроса будут выведены в stderr.</p>

<h3 id="запрос">Запрос</h3>

<p>Все сервисы, с которыми мне приходилось работать являются лишь логикой реакции на внешние события, чаще всего на http-вызов. Конечно часто логика реакции оказывается значительно более сложной, например, запрос создаёт задачу по обработке файлов, которая асинхронно продолжается в откреплённой горутине, либо запрос взводит таймер, который должен сработать через несколько часов или даже дней, совершив новые вызовы в другие системы. Это не говоря уже о том, что в рамках одного запроса происходит последовательно-параллельные запросы между сервисами системы. Есть очень маленькая доля событий, происходящих в сервисе, не привязанных к внешним вызовам: старт, разрыв соединения с базой данных, остановка. Для консистентности можно считать старт и остановку сервиса тоже отдельными вызовами со специальными идентификаторами.</p>

<p>Каждый запрос можно описать следующими полями, которые должны присутствовать во всех записях логов для удобства поиска:</p>

<ul>
<li><strong>команда</strong> — уникальное название класса запросов, например, <code>post.new</code> или <code>post.publish</code>. Чаще всего можно применить схему из пары: &lt;сущность&gt;.&lt;действие&gt;;</li>
<li><strong>идентификатор</strong> — уникальный идентификатор отдельного запроса. Если используется система трейсинга, такая как zipkin или jaeger, можно использовать идентификатор трейса;</li>
<li><strong>инициатор</strong> — инициатором может быть система (события старта и остановки), внешняя система (например, определяемая по заголовку User-Agent) либо пользователь (зарегистрированный или по крайней мере отмеченный кукой сессии);</li>
</ul>

<h3 id="сообщение">Сообщение</h3>

<p>Содержимое сообщение сильно зависит от предназначения сообщения и подробно описано в уровнях логирования.</p>

<h3 id="другое-1">Другое</h3>

<ul>
<li><strong>стек вызовов</strong> — как уже говорилось, применим для необработанных ошибок;</li>
<li><strong>дополнительная структурированная информация</strong> — может содержать неиндексируемую информацию, специфичную для разных типов записей, например, полный URL запроса или код ответа в подсистеме http-транспорта, привилегии пользователя в прослойке авторизации, идентификаторы запрашиваемых сущностей в подсистеме работы с бд. Также в этой части записи необходимо располагать значения метрик. Обогащая данную часть записи стоит оставаться умеренным и не писать дампы всех объектов, совершенно не нужные в большинстве случаев. Такие слепки могут пригодиться для насыщения контекста ошибки, но не для штатного поведения системы.</li>
<li><strong>файл и строка</strong> — часто встречаемый в библиотеках логирования функционал не имеющий особого применения в жизни. На ранних этапах разработки он позволяет быстро находить вызовы логирования в интересующем участке кода, но по мере развития проекта номер строки, а порой и имя файла меняется, так что лучше использовать уникальное сообщение и имя логгера для этих целей.</li>
</ul>

<h2 id="итого">Итого</h2>

<table>
<thead>
<tr>
<th>Задача</th>
<th>Уровень</th>
<th>Поиск</th>
<th>Группировка</th>
</tr>
</thead>

<tbody>
<tr>
<td>Отладка разрабатываемого функционала</td>
<td>DEBUG</td>
<td>пассивный</td>
<td>подсистема</td>
</tr>

<tr>
<td>Разбор некорректного поведения системы в прошлом</td>
<td>WARNING</td>
<td>время / команда / пользователь</td>
<td>подсистема / запрос</td>
</tr>

<tr>
<td>Разбор некорректного поведения системы в настоящем</td>
<td>DEBUG</td>
<td>идентификатор запроса</td>
<td>подсистема / запрос</td>
</tr>

<tr>
<td>Определение внешних проблем</td>
<td>ERROR</td>
<td>пассивный</td>
<td></td>
</tr>

<tr>
<td>Мониторинг здоровья сервиса</td>
<td>ERROR</td>
<td>пассивный</td>
<td></td>
</tr>

<tr>
<td>Мониторинг связанности среды</td>
<td>ERROR</td>
<td>пассивный</td>
<td>подсистема</td>
</tr>

<tr>
<td>Разбор ошибок при падении или отказе стартовать сервиса</td>
<td>ERROR</td>
<td>пассивный</td>
<td></td>
</tr>

<tr>
<td>Нахождение запроса в прошлом</td>
<td>INFO</td>
<td>время / команда / пользователь</td>
<td>подсистема / запрос</td>
</tr>

<tr>
<td>Восстановление контекста конкретного запроса</td>
<td>INFO</td>
<td>время / команда / пользователь</td>
<td>подсистема / запрос</td>
</tr>

<tr>
<td>Нахождение сервиса источника ошибки</td>
<td>WARNING</td>
<td>команда</td>
<td>подсистема / запрос</td>
</tr>

<tr>
<td>Возможность повторить запрос</td>
<td>INFO</td>
<td>идентификатор запроса</td>
<td>подсистема / запрос</td>
</tr>

<tr>
<td>Мониторинг различных участков кода на производительность</td>
<td>WARNING</td>
<td>идентификатор запроса</td>
<td>подсистема / запрос</td>
</tr>

<tr>
<td>Разбор отдельных запросов с построением карты</td>
<td>DEBUG</td>
<td>идентификатор запроса</td>
<td>подсистема / запрос</td>
</tr>

<tr>
<td>Формирование метрик</td>
<td>WARNING</td>
<td>пассивное</td>
<td>сообщение</td>
</tr>

<tr>
<td>События для сервисов оповещения</td>
<td>ERROR</td>
<td>пассивный</td>
<td></td>
</tr>
</tbody>
</table>

</div>

  
<footer class='entry-footer'>
  <div class='container sep-before'><div class='categories'><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <path d="M22,19a2,2,0,0,1-2,2H4a2,2,0,0,1-2-2V5A2,2,0,0,1,4,3H9l2,3h9a2,2,0,0,1,2,2Z"/>
  
</svg>
<span class='screen-reader-text'>category: </span><a class='category' href='/categories/develop/'>Разработка</a></div>
<div class='tags'><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <path d="M20.59,13.41l-7.17,7.17a2,2,0,0,1-2.83,0L2,12V2H12l8.59,8.59A2,2,0,0,1,20.59,13.41Z"/>
  <line x1="7" y1="7" x2="7" y2="7"/>
  
</svg>
<span class='screen-reader-text'>Тэги: </span><a class='tag' href='/tags/logging/'>logging</a>, <a class='tag' href='/tags/go/'>go</a></div>

  </div>
</footer>


</article>

<nav class='entry-nav'>
  <div class='container'><div class='prev-entry sep-before'>
      <a href='/post/2020/01/distributed-algorithms/'>
        <span aria-hidden='true'><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <line x1="20" y1="12" x2="4" y2="12"/>
  <polyline points="10 18 4 12 10 6"/>
  
</svg>
 Предыдущий</span>
        <span class='screen-reader-text'>Предыдущая запись: </span>Распределённые алгоритмы</a>
    </div><div class='next-entry sep-before'>
      <a href='/post/2021/04/work/'>
        <span class='screen-reader-text'>Следующая запись: </span>Работа над задачей<span aria-hidden='true'>Следующий <svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <line x1="4" y1="12" x2="20" y2="12"/>
  <polyline points="14 6 20 12 14 18"/>
  
</svg>
</span>
      </a>
    </div></div>
</nav>




      </main>

      <footer id='footer' class='footer'>
        <div class='container sep-before'><div class='copyright'>
  <p>Материалы распространяются по <a rel="noreferrer" href="https://creativecommons.org/licenses/by/4.0/" target="_blank">лицензии CC BY</a> &copy; 2018-2021 vporoshok <br>Увидели ошибку? Буду рад <a rel="noreferrer" href="https://github.com/vporoshok/vporoshok.github.io" target="_blank">PR&rsquo;у</a></p>
</div>

        </div>
      </footer>

    </div>
  </div><script>window.__assets_js_src="/assets/js/"</script>

<script src='/assets/js/main.67d669ac.js'></script>

</body>

</html>

